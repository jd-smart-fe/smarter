#!/usr/bin/env node

const program = require('commander');
const path = require('path');
const fs = require('fs-extra');
const exists = require('fs').existsSync;
const chalk = require('chalk');
const inquirer = require('inquirer');
const assets = require('../utils/assets');
const utils = require('../utils/utils');

program
  .usage('[option1 ... optionN]')
  .option('-h, --help', 'output usage information')
  .parse(process.argv);

(() => {
  if (program.H) {
    help();
    return;
  } else if (program.args.length < 1) { // 没有跟任何参数的话，也自动调用 help()
    help();
    return;
  }

  function help() {
    program.outputHelp();
    console.log();
    console.log();
    console.log('  Examples:');
    console.log();
    console.log(chalk.cyan('    # 生成 editorconfig eslint vscode 环境配置文件'));
    console.log('    $ smarter env editorconfig eslint vscode');
  }

  assets.getConfig().then(config => {

    const argsArry = program.args;
    const argsLength = program.args.length;
    let argsIndex = 0;
    // 添加配置文件方法
    const configName = argsArry[argsIndex];
    generateEnv(configName);

    process.on('exit', () => {
      // console.log();
    });

    function generateEnv(configName) {
      const local = path.join(utils.getProjectRootPath(), config.envConfig[configName].target);

      if (!configName) {
        configName = '.';
      }

      const inplace = configName === '.';

      if (exists(local)) {
        // 文件存在
        inquirer.prompt([{
          type: 'confirm',
          message: inplace ? 'Generate file in current directory?'
            : configName + ' settings file exists. Continue?',
          name: 'ok',
        }]).then(answers => {
          if (answers.ok) {
            create(configName);
          } else {
            argsIndex++;
            if (argsIndex < argsLength) {
              const configNames = argsArry[argsIndex];
              generateEnv(configNames);
            }
          }
        });
      } else {
        // 不存在
        // 判断目标路径是否需要放到文件夹内
        if (config.envConfig[configName].target.indexOf('/') >= 0) {
          const localSub = path.dirname(local);
          fs.mkdirp(localSub, err => {
            console.log();
          });
        }
        create(configName);
      }
    }

    function create(configName) {
      // 生成 editconfig 文件
      // 读取本地项目配置文件
      const datas = config.envConfig[configName];
      fs.readFile(config.envConfig[configName].source, 'utf-8', (err, data) => {
        if (err) {
          console.log(err);
        } else {
          // 覆盖或新建配置文件
          fs.writeFile(path.join(utils.getProjectRootPath(), config.envConfig[configName].target), data, 'utf8', errs => {
            if (err) {
              console.log(chalk.red(errs));
            } else {
              console.log(chalk.green('Generate file success'));
              argsIndex++;
              if (argsIndex < argsLength) {
                const configNames = argsArry[argsIndex];
                generateEnv(configNames);
              }
            }
          });
        }
      });
    }
  });
})();
